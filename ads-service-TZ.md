# Ads Service — Technical Specification (ТЗ)

## 1. Цель документа

Данный документ описывает техническое задание (ТЗ) на разработку сервиса объявлений (Ads Service),
построенного на микросервисной архитектуре. Документ предназначен для разработчиков, DevOps-инженеров,
QA и технических лидов.

---

## 2. Назначение системы

Система предназначена для:
- публикации и поиска объявлений;
- управления пользовательскими профилями;
- модерации контента;
- масштабируемой и отказоустойчивой работы в Kubernetes.

---

## 3. Технологический стек

### Backend
- Язык: **Go**
- Взаимодействие сервисов: **gRPC**
- API Gateway: **GraphQL**

### Хранилища данных
- PostgreSQL — основные данные
- MongoDB — медиа и вложения
- Elasticsearch — поиск

### Инфраструктура
- Очереди: RabbitMQ
- Аутентификация: JWT + Refresh Tokens
- CI/CD: GitHub Actions / GitLab CI
- Оркестрация: Kubernetes
- Деплой: Helm

---

## 4. Архитектура системы

### 4.1 Общая схема

Система состоит из независимых микросервисов, взаимодействующих по gRPC.
GraphQL Gateway является единой точкой входа для frontend-клиентов.

---

## 5. Описание сервисов

### 5.1 Auth Service

**Назначение:** управление аутентификацией и авторизацией.

**Функциональность:**
- Регистрация пользователя
- Аутентификация (login)
- Обновление access token через refresh token
- Email-подтверждение
- Восстановление пароля
- Управление ролями

**Роли:**
- `guest`
- `user`
- `admin`

**gRPC API:**
- ValidateToken
- RefreshToken
- GetUserRoles

---

### 5.2 User Service

**Назначение:** управление данными пользователей.

**Функциональность:**
- Хранение профиля пользователя:
  - email
  - телефон
  - имя
  - аватар
- Настройки:
  - уведомления
  - подписки
- Связь пользователя с объявлениями

---

### 5.3 Ad Service

**Назначение:** управление объявлениями.

**Функциональность:**
- Создание объявления
- Редактирование объявления
- Удаление объявления
- Просмотр объявления
- Изменение статуса объявления

**Статусы объявлений:**
- draft
- published
- on_moderation
- rejected
- deleted

**Хранение данных:**
- PostgreSQL — объявления и метаданные
- MongoDB — изображения и файлы

**События RabbitMQ:**
- `AdCreated`
- `AdUpdated`
- `AdDeleted`

---

### 5.4 Index / Search Service

**Назначение:** полнотекстовый поиск объявлений.

**Функциональность:**
- Подписка на события RabbitMQ
- Индексация данных в Elasticsearch
- Поиск по:
  - категориям
  - цене
  - геолокации
  - тексту
  - дате

**gRPC API:**
- SearchAds
- GetSuggestions

---

### 5.5 GraphQL Gateway

**Назначение:** единая точка входа для клиентов.

**Функциональность:**
- Авторизация через Auth Service
- Агрегация gRPC-запросов
- Разделение доступа:
  - Public API
  - User API
  - Admin API

---

## 6. Пользовательские сценарии

### 6.1 Гость
- Просмотр объявлений
- Поиск и фильтрация

### 6.2 Пользователь
- Регистрация и вход
- Создание и управление объявлениями
- Загрузка изображений
- Избранное и подписки

### 6.3 Администратор
- Модерация объявлений
- Блокировка пользователей
- Управление категориями

---

## 7. CI/CD Pipeline

### Этапы:
1. Проверка кода:
   - Unit-тесты
   - gRPC contract тесты
   - golangci-lint
   - go vet

2. Сборка:
   - Docker build
   - Push в registry

3. Деплой:
   - Helm upgrade/install
   - Автозапуск миграций PostgreSQL (golang-migrate)

---

## 8. Kubernetes и инфраструктура

### 8.1 Общие настройки
- Namespace: `ads-service`
- Ingress: nginx / traefik
- TLS: Cert-Manager + Let’s Encrypt

### 8.2 Сервисы
- auth-service
- user-service
- ad-service
- index-service
- graphql-gateway
- rabbitmq
- postgres
- mongodb
- elasticsearch

### 8.3 Конфигурация
- ConfigMap — конфигурация
- Secret — JWT ключи, пароли
- PVC — хранилища данных

### 8.4 Безопасность
- RBAC
- NetworkPolicy
- JWT проверка на Ingress уровне

---

## 9. Нефункциональные требования

- Горизонтальное масштабирование
- Отказоустойчивость
- Логирование и трассировка
- SLA-ready архитектура

---

## 10. Тестирование

- Unit-тесты
- Интеграционные тесты
- Контрактные тесты (Pact)
- Нагрузочное тестирование (опционально)

---

## 11. Структура репозитория

```text
/auth-service
/user-service
/ad-service
/index-service
/graphql-gateway
/infra
  /helm
.ci
Dockerfile
README.md
```

---

## 12. Окружения

- dev
- stage
- prod

Каждое окружение имеет отдельные Helm values.
